# サウンドリアルタイム解析ツールシステム - 技術仕様書

## 概要

本システムは、リアルタイム音声解析機能とサウンドデータ管理機能を統合したハイブリッドアプリケーションです。

### システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                     Soundman System                          │
├─────────────────────────┬───────────────────────────────────┤
│  Desktop App            │  Web App                          │
│  (Real-time Analysis)   │  (Data Management)                │
│                         │                                   │
│  C++ + JUCE            │  Vue.js + TypeScript              │
│  - Audio I/O           │  - File Browser                   │
│  - FFT Analysis        │  - Metadata Editor                │
│  - Waveform Display    │  - Search/Filter                  │
│  - Level Meters        │  - Preview Player                 │
└─────────────┬───────────┴──────────┬────────────────────────┘
              │                      │
              └──────────┬───────────┘
                         │
              ┌──────────▼──────────┐
              │  Shared Data Layer  │
              │                     │
              │  - JSON Metadata    │
              │  - Audio Files      │
              │  - Project Files    │
              └─────────────────────┘
```

## アーキテクチャ方針

### 完全分離型アーキテクチャ

デスクトップアプリとWebアプリは完全に独立して動作し、ファイルシステムを通じてデータを共有します。

**メリット：**
- 各アプリを独立して開発・デプロイ可能
- 技術スタックの選択が自由
- テストが容易
- 一方の障害が他方に影響しない

**デメリット：**
- リアルタイム同期には工夫が必要
- ファイルロックの管理が必要

## 技術スタック

### デスクトップアプリ（リアルタイム解析）

#### 言語・フレームワーク
- **言語**: C++17以上
- **フレームワーク**: JUCE 7.x
- **ビルドシステム**: CMake

#### 主要ライブラリ
- **オーディオ処理**: JUCE Audio Module
- **GUI**: JUCE GUI Module
- **FFT**: JUCE DSP Module (FFT実装含む)
- **ファイルI/O**: JUCE Core Module
- **JSON処理**: nlohmann/json または JUCE JSON

#### 対応プラットフォーム
- Windows 10/11 (WASAPI)
- macOS 10.15+ (CoreAudio)
- Linux (ALSA/JACK)

### Webアプリ（データ管理）

#### 言語・フレームワーク
- **フレームワーク**: Vue.js 3.x (Composition API)
- **言語**: TypeScript 5.x
- **ビルドツール**: Vite
- **パッケージマネージャ**: npm または pnpm

#### 主要ライブラリ
- **UI コンポーネント**:
  - Vuetify 3.x または Element Plus
- **状態管理**: Pinia
- **ルーティング**: Vue Router
- **オーディオ再生**: Howler.js または Web Audio API
- **波形表示**: WaveSurfer.js
- **グラフ描画**: Chart.js または D3.js
- **ファイル操作**: File System Access API

#### スタイリング
- **CSS フレームワーク**: Tailwind CSS または Vuetify
- **アイコン**: Material Design Icons

## データ層設計

### ディレクトリ構造

```
~/Soundman/
├── data/
│   ├── library.json          # ライブラリ全体のメタデータ
│   ├── projects/             # プロジェクトデータ
│   │   ├── project1.json
│   │   └── project2.json
│   └── cache/                # キャッシュデータ（波形画像等）
│       ├── waveforms/
│       └── thumbnails/
├── audio/                    # 音声ファイル
│   ├── samples/
│   ├── recordings/
│   └── processed/
└── config/                   # 設定ファイル
    ├── desktop-app.json
    └── web-app.json
```

### データフォーマット

#### library.json - ライブラリメタデータ

```json
{
  "version": "1.0.0",
  "lastModified": "2025-11-25T10:30:00Z",
  "files": [
    {
      "id": "uuid-v4",
      "path": "audio/samples/kick.wav",
      "name": "Kick Drum",
      "type": "audio/wav",
      "duration": 1.5,
      "sampleRate": 44100,
      "bitDepth": 24,
      "channels": 1,
      "size": 264600,
      "tags": ["drum", "kick", "electronic"],
      "bpm": null,
      "key": null,
      "metadata": {
        "artist": "",
        "album": "",
        "year": null
      },
      "analysis": {
        "rms": -12.5,
        "peak": -3.2,
        "spectralCentroid": 120.5,
        "zeroCrossingRate": 0.05
      },
      "createdAt": "2025-11-20T15:00:00Z",
      "modifiedAt": "2025-11-25T10:30:00Z"
    }
  ],
  "tags": ["drum", "kick", "electronic", "bass", "synth"],
  "projects": []
}
```

#### project.json - プロジェクトデータ

```json
{
  "id": "uuid-v4",
  "name": "My Project",
  "description": "Project description",
  "createdAt": "2025-11-25T10:00:00Z",
  "modifiedAt": "2025-11-25T10:30:00Z",
  "files": ["file-uuid-1", "file-uuid-2"],
  "settings": {
    "defaultSampleRate": 44100,
    "defaultBitDepth": 24
  }
}
```

### データアクセス戦略

#### デスクトップアプリ
- ファイルの直接読み書き
- JSON解析にはC++ライブラリを使用
- オーディオファイルはJUCE AudioFormatManager経由でアクセス

#### Webアプリ
- File System Access API（または従来のファイル選択）
- ローカルストレージにキャッシュ
- IndexedDB for 大容量データ

### 同期・排他制御

#### ファイルロック
- `.lock` ファイルによる簡易ロック機構
- 書き込み前にロックファイルをチェック
- タイムアウト処理で古いロックを解除

#### 変更通知
- ファイルシステムウォッチャー（デスクトップ）
- ポーリング（Web、必要に応じて）

## MVP（Phase 1）機能仕様

### デスクトップアプリ - Core Features

#### 1. オーディオ入力
- **マイク入力**
  - デバイス選択UI
  - サンプルレート設定（44.1kHz, 48kHz, 96kHz）
  - バッファサイズ設定
  - モノ/ステレオ対応

- **ファイル再生**
  - 対応フォーマット：WAV, AIFF, MP3, FLAC
  - 再生制御（Play, Pause, Stop）
  - ループ再生
  - 再生位置シーク

#### 2. リアルタイム波形表示
- オシロスコープビュー
- リアルタイム更新（60fps目標）
- ズーム・パン機能
- ステレオ表示（L/R別、またはXY）

#### 3. FFTスペクトラム解析
- **FFTパラメータ**
  - FFTサイズ：512, 1024, 2048, 4096, 8192
  - 窓関数：Hamming, Hann, Blackman
  - オーバーラップ：50%, 75%

- **表示モード**
  - バー表示
  - ライン表示
  - カラーマップ

- **スケール**
  - リニア/ログスケール（周波数軸）
  - dB表示（振幅軸）

#### 4. レベルメーター
- ピークレベル表示
- RMSレベル表示
- ピークホールド機能
- クリッピング検出・警告

#### 5. データエクスポート
- 解析結果のJSON出力
- 現在の表示のスクリーンショット保存

### Webアプリ - Core Features

#### 1. ファイル一覧
- グリッド/リスト表示切り替え
- ソート機能（名前、日付、サイズ、BPM等）
- ページネーション
- 波形サムネイル表示

#### 2. メタデータ表示・編集
- **基本情報**
  - ファイル名、パス
  - フォーマット、サイズ
  - サンプルレート、ビット深度
  - チャンネル数、長さ

- **編集可能フィールド**
  - タイトル
  - アーティスト
  - BPM
  - キー
  - タグ（複数）
  - 説明

- バッチ編集対応

#### 3. 検索・フィルタ
- **テキスト検索**
  - ファイル名
  - メタデータ
  - タグ

- **フィルタ**
  - ファイルタイプ
  - サンプルレート
  - BPM範囲
  - タグ
  - 日付範囲

- **保存済み検索**
  - よく使う検索条件を保存
  - スマートコレクション

#### 4. プレビュー再生
- インラインプレーヤー
- 波形表示
- 再生速度変更
- ループ再生
- キューポイント設定

#### 5. インポート・エクスポート
- ドラッグ&ドロップでファイル追加
- フォルダインポート
- メタデータCSVエクスポート
- プレイリストエクスポート

## UI/UX設計

### デスクトップアプリ

#### ウィンドウレイアウト
```
┌─────────────────────────────────────────────────────────────┐
│ Menu Bar: File | Edit | View | Audio | Help                 │
├─────────────────────────────────────────────────────────────┤
│ Toolbar: [Input] [Play] [Record] [Settings]                │
├───────────────────┬─────────────────────────────────────────┤
│                   │  Waveform Display                       │
│  Device Settings  │  ┌─────────────────────────────────┐   │
│                   │  │                                 │   │
│  [Input Device▼]  │  │      Real-time Waveform         │   │
│  [Sample Rate▼]   │  │                                 │   │
│  [Buffer Size▼]   │  │                                 │   │
│                   │  └─────────────────────────────────┘   │
│                   │                                         │
│  Level Meters     │  FFT Spectrum                          │
│  ┌─────────┐     │  ┌─────────────────────────────────┐   │
│  │ L │ R │ │     │  │                                 │   │
│  │ █ │ █ │ │     │  │      Frequency Spectrum         │   │
│  │ █ │ █ │ │     │  │                                 │   │
│  │ █ │ █ │ │     │  │                                 │   │
│  └─────────┘     │  └─────────────────────────────────┘   │
├───────────────────┴─────────────────────────────────────────┤
│ Status Bar: Ready | 44.1kHz | 24bit | Latency: 10ms        │
└─────────────────────────────────────────────────────────────┘
```

### Webアプリ

#### メインレイアウト
```
┌─────────────────────────────────────────────────────────────┐
│ Header: [Logo] [Search...] [User] [Settings]               │
├─────────────────────────────────────────────────────────────┤
│ Nav: [Library] [Projects] [Tags] [Import]                  │
├───────────┬─────────────────────────────────────────────────┤
│           │  Main Content Area                             │
│ Sidebar   │  ┌──────────┬──────────┬──────────┬──────────┐ │
│           │  │ [Thumb]  │ [Thumb]  │ [Thumb]  │ [Thumb]  │ │
│ Filters   │  │ File 1   │ File 2   │ File 3   │ File 4   │ │
│           │  │ 120 BPM  │ 128 BPM  │ 140 BPM  │ 100 BPM  │ │
│ [Tags▼]   │  └──────────┴──────────┴──────────┴──────────┘ │
│  □ drum   │  ┌──────────┬──────────┬──────────┬──────────┐ │
│  □ bass   │  │ [Thumb]  │ [Thumb]  │ [Thumb]  │ [Thumb]  │ │
│  □ synth  │  │ File 5   │ File 6   │ File 7   │ File 8   │ │
│           │  │ 90 BPM   │ 110 BPM  │ 150 BPM  │ 130 BPM  │ │
│ [BPM▼]    │  └──────────┴──────────┴──────────┴──────────┘ │
│  [90-150] │                                                 │
│           │  [< Prev] Page 1 of 10 [Next >]               │
├───────────┴─────────────────────────────────────────────────┤
│ Player: [▶] File.wav ━━━━●━━━━━ 1:23 / 3:45 [🔊]          │
└─────────────────────────────────────────────────────────────┘
```

## セキュリティ考慮事項

### ファイルアクセス
- サンドボックス内でのファイル操作
- パス検証（ディレクトリトラバーサル対策）
- ファイルサイズ制限

### データ検証
- JSON スキーマ検証
- オーディオファイルフォーマット検証
- メタデータのサニタイズ

## パフォーマンス目標

### デスクトップアプリ
- オーディオレイテンシー：10ms以下（バッファサイズ512以下）
- UI更新レート：60fps
- FFT処理：リアルタイム（44.1kHz, 2048サンプル）

### Webアプリ
- 初回ロード：3秒以内
- ページ遷移：1秒以内
- 1000ファイルのリスト表示：スムーズ（仮想スクロール使用）

## 拡張性

### プラグインシステム（将来）
- VST/AU プラグインホスト機能
- カスタムエフェクトプラグイン
- カスタムアナライザープラグイン

### API（将来）
- REST API for メタデータアクセス
- WebSocket for リアルタイム通知
- CLI ツール

## 開発環境要件

### デスクトップアプリ
- **Windows**: Visual Studio 2019以上
- **macOS**: Xcode 12以上
- **Linux**: GCC 9以上 / Clang 10以上
- CMake 3.18以上
- JUCE 7.x

### Webアプリ
- Node.js 18以上
- npm 9以上 または pnpm 8以上
- モダンブラウザ（Chrome 90+, Firefox 88+, Safari 14+, Edge 90+）

## テスト戦略

### デスクトップアプリ
- ユニットテスト：Google Test
- オーディオ処理テスト：テストオーディオファイル使用
- パフォーマンステスト：ベンチマーク

### Webアプリ
- ユニットテスト：Vitest
- コンポーネントテスト：Vue Test Utils
- E2Eテスト：Playwright
- 型チェック：TypeScript strict mode

## ビルド・デプロイ

### デスクトップアプリ
- CI/CD：GitHub Actions
- パッケージング：JUCE Projucer / CPack
- インストーラー：NSIS (Windows), DMG (macOS), AppImage (Linux)

### Webアプリ
- ビルド：Vite
- ホスティング：ローカル（file://）または静的ホスティング
- PWA対応（将来）

## まとめ

本アーキテクチャは、リアルタイム性が求められるオーディオ処理と、使いやすいデータ管理UIを、それぞれに最適な技術で実現する設計となっています。完全分離型により、各コンポーネントを独立して開発・改善できる柔軟性を持ちながら、ファイルシステムを介した効率的なデータ共有を実現します。
